<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- 增加移动端适应性 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dynamic Assessment Example</title>
  <!-- 引入 SheetJS 库，用于生成 Excel 文件 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* 基本样式 */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #e0f7fa, #ffffff);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    /* 开始页面 */
    #startPage {
      max-width: 600px;
      width: 90%;
      background-color: #fff;
      padding: 25px 20px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      margin: 20px;
      text-align: center;
    }
    #startPage p {
      font-size: 18px;
      color: #333;
      margin: 15px 0;
      line-height: 1.5;
    }
    #startPage label {
      font-size: 18px;
      margin: 5px;
      display: inline-block;
    }
    #startPage input {
      padding: 6px 10px;
      font-size: 16px;
      margin: 5px;
      width: 80%;
      max-width: 250px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    /* 题目区域容器 */
    .container {
      max-width: 600px;
      width: 90%;
      background-color: #fff;
      padding: 25px 20px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      margin: 15px;
    }
    /* 隐藏题目区域的外层容器，开始页面结束后显示 */
    #questionsPage {
      display: none;
      width: 100%;
    }
    /* 题目块 */
    .question-block {
      display: none;
    }
    .question-block.active {
      display: block;
    }
    /* 标题样式 */
    h3 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
      font-size: 20px;
    }
    /* 高亮样式 */
    .highlight {
      background-color: #fffd9e;
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: bold;
    }
    /* 正文段落 */
    p {
      font-size: 16px;
      line-height: 1.6;
      color: #555;
      margin-bottom: 15px;
    }
    /* 选项 */
    form label {
      display: block;
      font-size: 16px;
      margin: 10px 0;
      cursor: pointer;
    }
    input[type="radio"] {
      margin-right: 8px;
    }
    /* 按钮 */
    button {
      display: inline-block;
      margin-top: 15px;
      padding: 8px 16px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #45a049;
    }
    /* 级别反馈 */
    .level {
      display: none;
      margin-top: 15px;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 4px;
      background-color: #f9f9f9;
      font-size: 16px;
      color: #d32f2f;
    }
    /* 针对手机屏幕的进一步调整 */
    @media (max-width: 480px) {
      #startPage, .container {
        width: 95%;
        padding: 15px;
      }
      h3 {
        font-size: 18px;
      }
      p, form label {
        font-size: 15px;
      }
      button {
        font-size: 15px;
        padding: 8px 12px;
      }
      #startPage input {
        width: 90%;
        max-width: none;
      }
    }
  </style>
</head>
<body>
  <!-- 开始页面 -->
  <div id="startPage">
    <p>请不要中途退出页面，必须在20分钟内完成测试。</p>
    <p>请输入班级和学号：</p>
    <label>班级: <input type="text" id="class_name"></label>
    <label>学号: <input type="text" id="student_id"></label>
    <br>
    <button type="button" onclick="startTest()">开始答题</button>
  </div>
  
  <!-- 题目区域（初始隐藏） -->
  <div id="questionsPage">
    <!-- Question 1 -->
    <div class="container question-block active" id="question_q1">
      <h3>根据上下文推断加粗词汇 <strong class="highlight">ambivalent</strong> 的意思：</h3>
      <p>
        Jenny felt <strong class="highlight">ambivalent</strong> about the summer camp. “It’s free and fun!” her friend said <span class="highlight" style="display:none;">excitedly</span>, already planning what to pack. With a smile, Jenny <span class="highlight" style="display:none;">drew a big checkmark in the “YES” box on the form. Then her hand stopped.</span> She looked at the <span class="highlight" style="display:none;">two big piles of summer homework</span> on the desk. One was math. The other was a thick reading packet. Outside, children laughed while playing in the sun. Jenny opened her window slightly. The breeze smelled like cut grass. She sat there for a moment, not moving, the form still open in front of her.
      </p>
      <form id="form_q1">
        <label><input type="radio" name="q1" value="A"> A. 伤心的</label>
        <label><input type="radio" name="q1" value="B"> B. 矛盾的</label>
        <label><input type="radio" name="q1" value="C"> C. 兴奋的</label>
        <label><input type="radio" name="q1" value="D"> D. 冷漠的</label>
        <label><input type="radio" name="q1" value="E"> E. 困惑的</label>
        <button type="button" onclick="checkAnswer('q1')">Submit Answer</button>
      </form>
      <div id="q1_level1" class="level">
        Incorrect! Please try again. Take another close look at the highlighted sentences—what do the changes in the character’s actions suggest? How does that make you feel?
      </div>
      <div id="q1_level2" class="level">
        Incorrect! Please try again. Based on highlighted sentences, try to think about why Jenny first smiled and checked the ‘YES’ box, but then suddenly stopped and stared at her homework. What do you think she might be thinking? How does that make you feel?
      </div>
      <div id="q1_level3" class="level">
        Incorrect! Please try again. If you were Jenny—excited about summer camp but also facing piles of summer homework—what complex feelings might you experience in that moment?
      </div>
      <div id="q1_level4" class="level">
        Incorrect! Jenny’s actions suggest that she wanted to go to summer camp but was also worried about her unfinished homework. This kind of feeling—wanting something but hesitating due to other concerns—is best described as ‘矛盾的’.
      </div>
    </div>
    
    <!-- Question 2 -->
    <div class="container question-block" id="question_q2">
      <h3>根据上下文推断加粗词汇 <strong class="highlight">bereavement</strong> 的意思：</h3>
      <p>
        It was already April, but John <span class="highlight" style="display:none;">still hadn’t opened the curtains</span> in the small bedroom upstairs. One afternoon, John was looking for batteries and opened a locked drawer by mistake. He <span class="highlight" style="display:none;">stopped suddenly</span>, quietly staring at the <span class="highlight" style="display:none;">scarf inside, carefully folded</span>. Slowly, he touched it, then closed the drawer again. Later, when his friends asked him to join them for dinner, John shook his head and said softly, “Maybe next time.” Nobody asked more questions, but <span class="highlight" style="display:none;">they looked at each other quietly</span>. John’s <strong class="highlight">bereavement</strong> was quiet, hidden behind closed doors, yet everyone could feel something had deeply changed.
      </p>
      <form id="form_q2">
        <label><input type="radio" name="q2" value="A"> A. 长期孤独</label>
        <label><input type="radio" name="q2" value="B"> B. 丧亲之痛</label>
        <label><input type="radio" name="q2" value="C"> C. 身体不适</label>
        <label><input type="radio" name="q2" value="D"> D. 事业受阻</label>
        <label><input type="radio" name="q2" value="E"> E. 思念之情</label>
        <button type="button" onclick="checkAnswer('q2')">Submit Answer</button>
      </form>
      <div id="q2_level1" class="level">
        Incorrect! Please try again. Take another close look at the highlighted sentences—what John did after he opened the drawer. What do his quiet actions suggest? How did his behavior make you feel?
      </div>
      <div id="q2_level2" class="level">
        Incorrect! Please try again. Think about why John suddenly stopped when he saw the scarf, and why he turned down dinner with his friends. What might he be feeling or thinking at that moment? How would that make you feel?
      </div>
      <div id="q2_level3" class="level">
        Incorrect! Please try again. Imagine you were John, and the scarf reminded you of someone. How would you feel? What kind of emotions might make it hard to open the curtains or go out with friends?
      </div>
      <div id="q2_level4" class="level">
        Incorrect! John’s actions show that he is quietly sad because the loss of someone close to him. He stays away from sunlight, keeps the room shut, and doesn’t talk much to his friends. This kind of strong, hidden sadness from losing someone close is best called ‘丧亲之痛’.
      </div>
    </div>
  </div>
  
  <!-- 导出及提交按钮区域 -->
  <div class="container" id="resultContainer" style="display: none; text-align: center;">
    <button type="button" onclick="exportResults()">Export Results and Proceed</button>
  </div>
  
  <script>
    // 开始测试：验证班级和学号填写后，隐藏开始页面，显示题目区域
    function startTest() {
      let studentClass = document.getElementById("class_name").value.trim();
      let studentID = document.getElementById("student_id").value.trim();
      if (studentClass === "" || studentID === "") {
        alert("请完整填写班级和学号！");
        return;
      }
      // 隐藏开始页面，显示题目区域
      document.getElementById("startPage").style.display = "none";
      document.getElementById("questionsPage").style.display = "block";
    }
    
    // Correct answers and maximum attempts
    const correctKeys = { q1: "B", q2: "B" };
    const maxAttempts = 4;
    // Records for attempts, answer history, and question status
    let attempts = { q1: 0, q2: 0 };
    let answerHistory = { q1: [], q2: [] };
    let questionStatus = { q1: false, q2: false };
    
    // Question order and current question id
    const questionIds = ["q1", "q2"];
    let currentQ = questionIds[0];
    
    // Function to check the answer for a given question id
    function checkAnswer(qid) {
      if (questionStatus[qid]) {
        alert("This question has already been answered correctly!");
        return;
      }
      // Hide all level feedback for current question
      for (let i = 1; i <= maxAttempts; i++) {
        let levelDiv = document.getElementById(`${qid}_level${i}`);
        if (levelDiv) levelDiv.style.display = 'none';
      }
      
      // 第一次错误时直接显示题干中所有隐藏的高亮部分
      if (attempts[qid] === 0) {
        document.querySelectorAll(`#question_${qid} p span.highlight`).forEach(el => {
          el.style.display = 'inline';
        });
      } else {
        document.querySelectorAll(`#question_${qid} p span.highlight`).forEach(el => {
          el.style.display = 'inline';
        });
      }
      
      // 获取选中答案
      const radios = document.getElementsByName(qid);
      let selected = "";
      for (const radio of radios) {
        if (radio.checked) {
          selected = radio.value;
          break;
        }
      }
      if (!selected) {
        alert("Please select an answer!");
        return;
      }
      answerHistory[qid].push(selected);
      attempts[qid]++;
      
      if (selected === correctKeys[qid]) {
        questionStatus[qid] = true;
        alert("Correct Answer!");
        // 禁用当前题的所有选项
        radios.forEach(radio => radio.disabled = true);
        nextQuestion();
      } else {
        // 显示对应的提示
        if (attempts[qid] <= maxAttempts) {
          document.getElementById(`${qid}_level${attempts[qid]}`).style.display = 'block';
        }
        // 超过最大尝试后，禁用选项并跳转至下一题
        if (attempts[qid] >= maxAttempts) {
          radios.forEach(radio => radio.disabled = true);
          nextQuestion();
        }
      }
    }
    
    // 切换到下一题
    function nextQuestion() {
      document.getElementById("question_" + currentQ).classList.remove("active");
      const currentIndex = questionIds.indexOf(currentQ);
      if (currentIndex < questionIds.length - 1) {
        currentQ = questionIds[currentIndex + 1];
        document.getElementById("question_" + currentQ).classList.add("active");
      } else {
        document.getElementById("resultContainer").style.display = "block";
      }
    }
    
    // 计算分数、生成 Excel 并跳转提交链接
    function exportResults() {
      let pretestTotal = 0;
      let posttestTotal = 0;
      let data = [["Question", "Answer History", "Basic Score", "Posttest Score", "LPS (Item)"]];
      
      questionIds.forEach(qid => {
        let basic = 0;
        let post = 0;
        if (questionStatus[qid]) {
          if (attempts[qid] === 1) {
            basic = 4;
            post = 0;
          } else if (attempts[qid] === 2) {
            basic = 0;
            post = 3;
          } else if (attempts[qid] === 3) {
            basic = 0;
            post = 2;
          } else if (attempts[qid] === 4) {
            basic = 0;
            post = 1;
          }
        }
        pretestTotal += basic;
        posttestTotal += post;
        let lps_item = ((2 * post) - basic) / 4;
        data.push([qid, answerHistory[qid].join(","), basic, post, lps_item.toFixed(3)]);
      });
      
      let numItems = questionIds.length;
      let smax = numItems * 4;
      let totalLPS = ((2 * posttestTotal) - pretestTotal) / smax;
      
      // 在结果表最前面加入学号和班级信息
      let studentClass = document.getElementById("class_name").value;
      let studentID = document.getElementById("student_id").value;
      let headerRows = [
          ["班级:", studentClass],
          ["学号:", studentID],
          []  // 空行
      ];
      
      data = headerRows.concat(data);
      
      // 在Excel中增加总分行
      data.push([]);
      data.push(["Total", "", pretestTotal, posttestTotal, totalLPS.toFixed(3)]);
      
      // 生成工作表及工作簿
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Results");
      const wbout = XLSX.write(wb, {bookType: 'xlsx', type: 'binary'});
      
      // 二进制字符串转为 Blob 对象
      function s2ab(s) {
        const buf = new ArrayBuffer(s.length);
        const view = new Uint8Array(buf);
        for (let i = 0; i < s.length; i++) {
          view[i] = s.charCodeAt(i) & 0xFF;
        }
        return buf;
      }
      const blob = new Blob([s2ab(wbout)], { type: "application/octet-stream" });
      const url = URL.createObjectURL(blob);
      const downloadLink = document.createElement("a");
      downloadLink.href = url;
      downloadLink.download = "result.xlsx";
      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);
      
      // 2秒后跳转到提交链接
      setTimeout(function() {
        window.location.href = "https://c.wss.pet/s/gqzbglms1r8";
      }, 2000);
    }
  </script>
</body>
</html>
